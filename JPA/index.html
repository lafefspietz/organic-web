<!doctype html>
<html lang="en">
<head>
   <meta charset="utf-8">
   <!--

-->
<link href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//wAA//8AAPv/AAD4/wAA+38AAPufAAD77wAAA/AAAPvvAAD7nwAA+38AAPj/AAD7/wAA//8AAP//AAD//wAA" rel="icon" type="image/x-icon">


   <title>JPA</title>    
   <script src="https://cdn.jsdelivr.net/npm/p5@1.7.0/lib/p5.js"></script>
</head>
<body> 
<div id = "controlscroll">
    <h1>VNA CONTROLS</h1>
    <table id = "vnatable"></table>
    <H1>PUMP CONTROLS</H1>
    <table id = "pumptable"></table>
<p>
    <a href = "edit-index.html">edit-index.html</a>
</p>
<p>
    <a href = "edit-web-files.html">edit-web-files.html</a>
    
</p>    
</div>
<style>
body{
    font-family:Arial;
    background-color:#404040;
    color:#0CCDDF;
}
input{
    color:#00ff00;
    background-color:black;
    font-family:courier;
    border-color:#0CCDDF;
}
h1{
    text-align:center;
}
#controlscroll{
    overflow:scroll;
    position:absolute;
    left:0px;
    top:0px;
    bottom:0px;
    padding-left:1em;
    padding-right:1em;
    background-color:#0a0a0a;
}
table{
    border:solid;
    border-color:#0CCDDF;
}
a{
    color:#ff2cb4;
}

main{
    position:absolute;
    right:0px;
    top:0px;
    cursor:pointer;
}
</style>
<script>

document.getElementById("controlscroll").style.right = (innerHeight + 5).toString() + "px";


vna = {};
vna.power = -30;//dBm
vna.ifbw = 2000;//Hz
vna.fstart = 6.25;//GHz
vna.fstop = 6.75;//Ghz
vna.fcenter = 6.5;//Ghz
vna.fspan = 0.5;//Ghz
vna.numpoints = 401;
for(attribute in vna){
    var newtr = document.createElement("TR");
    var newtd = document.createElement("TD");
    newtr.appendChild(newtd);
    newtd.innerHTML = attribute + ": ";
    document.getElementById("vnatable").appendChild(newtr);
    var newtd = document.createElement("TD");
    newtr.appendChild(newtd);
    var newinput =  document.createElement("INPUT");
    newtd.appendChild(newinput);
    newinput.value = vna[attribute];
}

pump = {};
pump.frequency = 13.0;//GHz
pump.on = true;
pump.power = 3.43;

for(attribute in pump){
    var newtr = document.createElement("TR");
    var newtd = document.createElement("TD");
    newtr.appendChild(newtd);
    newtd.innerHTML = attribute + ": ";
    document.getElementById("pumptable").appendChild(newtr);
    var newtd = document.createElement("TD");
    newtr.appendChild(newtd);
    var newinput =  document.createElement("INPUT");
    newtd.appendChild(newinput);
    newinput.value = pump[attribute];
}


v_digit_index = -1;
p_digit_index = -1;
v_digit_array = [1,0,5,6,0,0,0];
p_digit_array = [1,3,5,0];
var httpc = new XMLHttpRequest();
httpc.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        control_json = JSON.parse(this.responseText);
        v_digit_array = control_json.v_digit_array;
        p_digit_array = control_json.p_digit_array;
    }
};
httpc.open("GET", "load-file.php?filename=control.json", true);
httpc.send();

traceindex= 0;
tracejson = {};
var httpc = new XMLHttpRequest();
httpc.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        tracejson = JSON.parse(this.responseText);
    }
};
httpc.open("GET", "load-file.php?filename=ampdatajson/trace" + traceindex.toString() + ".json", true);
httpc.send();


function setup() {
    createCanvas(innerHeight-5,innerHeight-5);    
    strokeWeight(1);  
}





function draw(){
    clear();
    stroke("#0CCDDF");
    noFill();
    background(10);
    strokeWeight(1);
    for(var index = 2;index < 10;index++){
  //      line(index*0.1*width,0.8*height,index*0.1*width,height);
    }
    for(var index = 6;index < 10;index++){
        if(index%2==0){
//            line(0,index*0.1*height,width,index*0.1*height);
        }
    }

    fill(50);
    if(mouseX > 0.2*width && mouseX < 0.9*width && mouseY > 0.6*height && mouseY < 0.8*height){
        v_digit_index = Math.floor((mouseX - 0.2*width)/(0.1*width));
        rect(0.2*width + v_digit_index*0.1*width,0.6*height,0.1*width,0.2*height);
    }
    else{
        v_digit_index = -1;
    }
    if(mouseX > 0.2*width && mouseX < 0.6*width && mouseY > 0.8*height && mouseY < height){
        p_digit_index = Math.floor((mouseX - 0.2*width)/(0.1*width));
        rect(0.2*width + p_digit_index*0.1*width,0.8*height,0.1*width,0.2*height);
    }
    else{
        p_digit_index = -1;
    }

    fill("#0CCDDF");
    textSize(width*0.15);
    text("V= ",10,0.6*height + 2*width*0.1 -50);
    text(".",0.1*width*3.75, 0.6*height + 2*width*0.1 -50);

    text("P= ",10,0.8*height + 2*width*0.1 -50);
    text(".",0.1*width*3.75, 0.8*height + 2*width*0.1 -50);

    if(v_digit_array[0] == 1){
        text("+",width*0.2 + 5,0.6*height + 2*width*0.1 -50);
    }
    else{
        text("-",width*0.2 + 5,0.6*height + 2*width*0.1 -50);
    }
    for(var index = 1;index < v_digit_array.length;index++){
        text(v_digit_array[index].toString(),(2 + index)*width*0.1 + 5,0.8*height - 50);
    }
    text("V",(9)*width*0.1 ,0.8*height - 50);

    if(p_digit_array[0] == 1){
        text("+",width*0.2 + 5,0.8*height + 2*width*0.1 -50);
    }
    else{
        text("-",width*0.2 + 5,0.8*height + 2*width*0.1 -50);
    }
    for(var index = 1;index < p_digit_array.length;index++){
        text(p_digit_array[index].toString(),(2 + index)*width*0.1 + 5,height - 50);
    }
    text("dBm",(6)*width*0.1 + 15,height - 50);


    strokeWeight(10);  
    line(0,0.6*height,width,0.6*height);
    noFill();
/*
    beginShape();
    for(var x = 0;x < width;x++){
        vertex(x,0.3*height + randomGaussian(0,10) + Math.exp(-((x - width/2)**2)/100000)*0.15*height*Math.sin(2*Math.PI*x/100));
    }
    endShape();
  */
  
    textSize(width*0.1);
    stroke("red");
    fill('red');
    text("JPA",10,width*0.1);
    
    var httpc = new XMLHttpRequest();
    httpc.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            tracejson = JSON.parse(this.responseText);
        }
    };
    httpc.open("GET", "load-file.php?filename=ampdatajson/trace" + traceindex.toString() + ".json", true);
    httpc.send();
    
    stroke("#0CCDDF");
    noFill();
    strokeWeight(10);  
    beginShape();
    for(var index = 0;index < tracejson.fghz.length;index++){
        vertex(map(index,0,tracejson.fghz.length,0,width),map(tracejson.gaindb[index],0,30,0.6*height,0));
    }
    endShape();

    stroke("red");
    noFill();
    strokeWeight(5);  
    beginShape();
    for(var index = 0;index < tracejson.fghz.length;index++){
        vertex(map(index,0,tracejson.fghz.length,0,width),map(tracejson.gaindbfit[index],0,30,0.6*height,0));
    }
    endShape();

    stroke("blue");
    
    peak = map(tracejson.curvepeak,0,30,0,0.6*height);
    fwhm = map(tracejson.fwhm,0,tracejson.fghz[tracejson.fghz.length-1] - tracejson.fghz[0],0,width);
    f0 = map(tracejson.f0,tracejson.fghz[0],tracejson.fghz[tracejson.fghz.length-1],0,width);

    line(0,0.6*height - peak,width,0.6*height - peak);
    line(f0,0,f0,height);
    line(f0 + 0.5*fwhm,0,f0 + 0.5*fwhm,height);
    line(f0 - 0.5*fwhm,0,f0 - 0.5*fwhm,height);
    
    fill("#ff00ff20");
    rect(f0 - 0.5*fwhm,0.6*height,fwhm,-peak);
  //  rect(f0 ,0.6*height,100,100);
  //  console.log(fwhm);
    //rect(f0-0.5*fwhm,0.6*height,peak,fwhm);
  
    traceindex++;
    if(traceindex >= 100){
        traceindex = 0;
    }
}





function keyPressed() {
  if (key.charCodeAt(0) >= 060 && key.charCodeAt(0) < 072) {
       if(v_digit_index >= 1){
           v_digit_array[v_digit_index] = parseInt(key.charCodeAt(0)) - 060;
       }
       if(p_digit_index >= 1){
           p_digit_array[p_digit_index] = parseInt(key.charCodeAt(0)) - 060;
       }
  }
  if (keyCode === DOWN_ARROW && v_digit_index >= 1) {
        v_digit_array[v_digit_index]--;
        if(v_digit_array[v_digit_index] < 0){
            v_digit_array[v_digit_index] = 9;
        }
  }
  if (keyCode === UP_ARROW && v_digit_index >= 1) {
        v_digit_array[v_digit_index]++;
        if(v_digit_array[v_digit_index] > 9){
            v_digit_array[v_digit_index] = 0;
        }
  }
  if (v_digit_index == 0 &&(keyCode === UP_ARROW || keyCode === DOWN_ARROW)) {
        v_digit_array[0] = -1*v_digit_array[0];
  }
  if (p_digit_index == 0 &&(keyCode === UP_ARROW || keyCode === DOWN_ARROW)) {
        p_digit_array[0] = -1*p_digit_array[0];
  }


  if (keyCode === DOWN_ARROW && p_digit_index >= 1) {
        p_digit_array[p_digit_index]--;
        if(p_digit_array[p_digit_index] < 0){
            p_digit_array[p_digit_index] = 9;
        }
  }

  if (keyCode === UP_ARROW && p_digit_index >= 1) {
        p_digit_array[p_digit_index]++;
        if(p_digit_array[p_digit_index] > 9){
            p_digit_array[p_digit_index] = 0;
        }
  }
  savejson();
}

direction = '';
function mouseWheel(event) {
  if (event.delta > 0) {
    direction = 'mouse wheel down';
    if (v_digit_index >= 1) {
        v_digit_array[v_digit_index]--;
        if(v_digit_array[v_digit_index] < 0){
            v_digit_array[v_digit_index] = 9;
        }
    }
    if (p_digit_index >= 1) {
        p_digit_array[p_digit_index]--;
        if(p_digit_array[p_digit_index] < 0){
            p_digit_array[p_digit_index] = 9;
        }
    }
  } else {
    direction = 'mouse wheel up';
    if (v_digit_index >= 1) {
        v_digit_array[v_digit_index]++;
        if(v_digit_array[v_digit_index] > 9){
            v_digit_array[v_digit_index] = 0;
        }
    }
    if( p_digit_index >= 1) {
        p_digit_array[p_digit_index]++;
        if(p_digit_array[p_digit_index] > 9){
            p_digit_array[p_digit_index] = 0;
        }
    }
    
  }
  if (v_digit_index == 0 ) {
        v_digit_array[0] = -1*v_digit_array[0];
  }
  if (p_digit_index == 0 ) {
        p_digit_array[0] = -1*p_digit_array[0];
  }  
  
  savejson();

  // Uncomment to prevent any default behavior.
  // return false;
}



function savejson(){
    v = 0;
    for(var index=1;index < v_digit_array.length;index++){
        v += v_digit_array[index]*10**(1-index);
    }
    v *= v_digit_array[0];//sign
    p = 0;
    for(var index=1;index < p_digit_array.length;index++){
        p += p_digit_array[index]*10**(1-index);
    }
    p *= p_digit_array[0];//sign
    
    control_json.p = p;
    control_json.v = v;
    control_json.v_digit_array = v_digit_array;
    control_json.p_digit_array = p_digit_array;

    var httpc = new XMLHttpRequest();
    httpc.open("POST", "save-file.php", true);
    httpc.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    httpc.send("data="+encodeURIComponent(JSON.stringify(control_json,null,"    "))+"&filename=control.json");//send text to save-file.php
}
</script>
</body>
</html>


    
    
